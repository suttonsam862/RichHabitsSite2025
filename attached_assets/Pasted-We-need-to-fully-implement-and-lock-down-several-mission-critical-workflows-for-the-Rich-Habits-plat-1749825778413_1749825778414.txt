We need to fully implement and lock down several mission-critical workflows for the Rich Habits platform. Do not proceed until each point is covered thoroughly. Do not introduce fallback logic. All fixes must be airtight, verified, and logged.

---

### 🔒 PART 1 — FIX STRIPE PAYMENT SYSTEM FOR EVENT SIGNUPS

1. ✅ Remove all mock/fallback event mappings (e.g., `|| 1`, `eventSlugToIdMap`)
2. ✅ In `stripe.ts` and `routes.ts`:
   - Look up the event using the actual `eventId` UUID from the frontend form
   - If invalid or not found, fail the request and log the error
3. ✅ Stripe `PaymentIntent` metadata must include:
   - `eventId`, `eventName`, and all form fields (name, grade, shirt size, school, etc.)
4. ✅ Stripe webhook should:
   - Validate metadata against real database events
   - Reject or ignore any `payment_intent.succeeded` with unknown or missing event ID
5. ✅ After validation, successful payments should:
   - Create a registration record
   - Trigger `createShopifyOrderFromRegistration(...)`
   - Save `shopifyOrderId` and `stripePaymentIntentId` into the registration row

---

### 🛍️ PART 2 — BUILD FULL VARIANT IMAGE-TO-COLOR UX ON PRODUCT PAGES

1. ✅ On `/shop/:handle` product pages:
   - Selecting a color should update the main product image
   - Use `variant.image.url` from the Shopify Storefront API to link color to image
2. ✅ Add variant selector UI (dropdown or swatches)
3. ✅ Selecting a variant should also update:
   - Price
   - Availability
   - Shopify variant ID stored for Add to Cart
4. ✅ Do not break routing — all `/shop/:handle` pages must load fully

---

### 🛒 PART 3 — COMPLETE SHOPIFY-BACKED RETAIL CART

1. ✅ Only show “Add to Cart” on **retail** product pages (not events)
2. ✅ Add to Cart stores:
   - Shopify product ID
   - Shopify variant ID
   - Quantity
   - Title, price, image
3. ✅ Build `/cart` route UI:
   - Users can view all added items
   - Remove/edit quantity
   - Click “Checkout” to start Shopify checkout
4. ✅ At checkout, send the correct variant IDs and quantities to Shopify to initiate session

---

### 🧑‍🤝‍🧑 PART 4 — SIMPLIFY TEAM REGISTRATION

1. ✅ Remove parentName, parentPhone, and any guardian fields from team registration form
2. ✅ Only collect:
   - Coach name + email (team contact)
   - Athlete first + last name
3. ✅ Backend schema must not reject athlete rows missing parent info

--
