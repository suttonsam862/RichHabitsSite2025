review:
  goals:
    - Identify logic errors in payment processing
    - Validate discount code handling and propagation
    - Detect mismatches between frontend-displayed price and backend charge
    - Flag unhandled JSON parsing or request payload issues
    - Surface any silent failures or false positives in payment confirmation
    - Ensure Stripe integration is consistent, secure, and error-handled
    - Find async/race condition risks in payment or form submission flow

  rules:
    - Flag any instance where a discount is shown on the frontend but not used in backend pricing
    - Flag hardcoded price values that bypass dynamic calculations
    - Flag any JSON parsing without a try/catch block
    - Flag lack of validation on critical fields like `amount`, `discount`, or `promoCode`
    - Flag improper handling of Stripe errors (e.g., silent catch blocks)
    - Flag frontend prices not being recalculated after discount updates
    - Flag lack of idempotency in payment API calls
    - Flag repeated or scattered discount logic across files
    - Flag cases where discount is applied after tax or fee incorrectly

  severity:
    high:
      - Any mismatch between displayed price and charged amount
      - Any Stripe charge submitted with incorrect or missing discount
      - JSON errors that crash or silently fail the payment submission
    medium:
      - UI feedback not reflecting backend state (e.g., "discount applied" but charge failed)
      - Errors not shown to the user after payment attempt
    low:
      - Warnings in payment logs not surfaced to user/admin
      - Inefficient discount validation logic

  files:
    include:
      - "**/checkout.js"
      - "**/payment.js"
      - "**/stripe.js"
      - "**/submitPayment*"
      - "**/api/**"
      - "**/discount*"
    exclude:
      - "**/*.test.js"
      - "**/mock/**"

  recommendations:
    - Suggest secure and traceable logging for payment failures
    - Recommend modular discount/fee utilities
    - Recommend use of unified pricing validator shared by frontend and backend